<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase ì—°ê²° í…ŒìŠ¤íŠ¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0A0A0A 0%, #1a1a1a 100%);
            color: #ffffff;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        h1 {
            color: #D4AF37;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }
        
        .test-section {
            background: #2A2A2A;
            border: 1px solid #D4AF37;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-title {
            color: #D4AF37;
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .status.pending {
            background: #666;
            color: #fff;
        }
        
        .status.success {
            background: #4CAF50;
            color: #fff;
        }
        
        .status.error {
            background: #f44336;
            color: #fff;
        }
        
        .result {
            background: #1a1a1a;
            border-left: 4px solid #D4AF37;
            padding: 15px;
            margin-top: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        
        button {
            background: #D4AF37;
            color: #0A0A0A;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #b8941f;
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .progress {
            text-align: center;
            color: #D4AF37;
            font-size: 1.2rem;
            margin: 20px 0;
        }
        
        .error-message {
            color: #f44336;
            background: rgba(244, 67, 54, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .success-message {
            color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Supabase ì—°ê²° í…ŒìŠ¤íŠ¸</h1>
        
        <div class="test-section">
            <div class="test-title">
                <span>Test 1: í™˜ê²½ ë³€ìˆ˜ í™•ì¸</span>
                <span class="status pending" id="status-1">ëŒ€ê¸° ì¤‘</span>
            </div>
            <div class="result" id="result-1">í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ë ¤ë©´ "ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>
        </div>
        
        <div class="test-section">
            <div class="test-title">
                <span>Test 2: Supabase ì—°ê²°</span>
                <span class="status pending" id="status-2">ëŒ€ê¸° ì¤‘</span>
            </div>
            <div class="result" id="result-2">-</div>
        </div>
        
        <div class="test-section">
            <div class="test-title">
                <span>Test 3: ì¶”ì²œ ì½”ë“œ ìƒì„± í•¨ìˆ˜</span>
                <span class="status pending" id="status-3">ëŒ€ê¸° ì¤‘</span>
            </div>
            <div class="result" id="result-3">-</div>
        </div>
        
        <div class="test-section">
            <div class="test-title">
                <span>Test 4: ì¶”ì²œ ì½”ë“œ ê²€ì¦ í•¨ìˆ˜</span>
                <span class="status pending" id="status-4">ëŒ€ê¸° ì¤‘</span>
            </div>
            <div class="result" id="result-4">-</div>
        </div>
        
        <div class="test-section">
            <div class="test-title">
                <span>Test 5: ì „ì²´ ë“±ë¡ ìˆ˜ ì¡°íšŒ</span>
                <span class="status pending" id="status-5">ëŒ€ê¸° ì¤‘</span>
            </div>
            <div class="result" id="result-5">-</div>
        </div>
        
        <div class="test-section">
            <div class="test-title">
                <span>Test 6: Auth íŠ¸ë¦¬ê±° í™•ì¸</span>
                <span class="status pending" id="status-6">ëŒ€ê¸° ì¤‘</span>
            </div>
            <div class="result" id="result-6">-</div>
        </div>
        
        <div class="button-group">
            <button onclick="runAllTests()">ğŸš€ ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
            <button onclick="location.href='http://localhost:5173'">ğŸ“± ë©”ì¸ ì•±ìœ¼ë¡œ ì´ë™</button>
        </div>
        
        <div class="progress" id="progress"></div>
    </div>
    
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        window.supabase = null;
        window.testResults = {
            total: 6,
            passed: 0,
            failed: 0
        };
        
        function updateStatus(testNum, status, message) {
            const statusEl = document.getElementById(`status-${testNum}`);
            const resultEl = document.getElementById(`result-${testNum}`);
            
            statusEl.className = `status ${status}`;
            statusEl.textContent = status === 'success' ? 'âœ… ì„±ê³µ' : status === 'error' ? 'âŒ ì‹¤íŒ¨' : 'â³ í…ŒìŠ¤íŠ¸ ì¤‘';
            
            if (message) {
                resultEl.textContent = message;
            }
            
            if (status === 'success') {
                window.testResults.passed++;
            } else if (status === 'error') {
                window.testResults.failed++;
            }
        }
        
        function updateProgress() {
            const progress = document.getElementById('progress');
            const { passed, failed, total } = window.testResults;
            const completed = passed + failed;
            
            if (completed === total) {
                if (failed === 0) {
                    progress.innerHTML = `ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼! (${passed}/${total})`;
                    progress.style.color = '#4CAF50';
                } else {
                    progress.innerHTML = `âš ï¸ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ì„±ê³µ: ${passed}, ì‹¤íŒ¨: ${failed})`;
                    progress.style.color = '#f44336';
                }
            } else {
                progress.innerHTML = `ì§„í–‰ ì¤‘... (${completed}/${total})`;
            }
        }
        
        async function test1_checkEnvVars() {
            updateStatus(1, 'pending');
            
            try {
                // Vite í™˜ê²½ ë³€ìˆ˜ëŠ” import.meta.envë¡œ ì ‘ê·¼í•´ì•¼ í•˜ì§€ë§Œ
                // ì´ íŒŒì¼ì€ ë…ë¦½ HTMLì´ë¯€ë¡œ ì§ì ‘ ì ‘ê·¼ ë¶ˆê°€
                // ëŒ€ì‹  Supabase ì—°ê²° ì‹œë„ë¡œ ê°„ì ‘ í™•ì¸
                
                const result = `
í™˜ê²½ ë³€ìˆ˜ í™•ì¸:
- VITE_SUPABASE_URL: ${import.meta.env?.VITE_SUPABASE_URL ? 'âœ… ì„¤ì •ë¨' : 'âŒ ë¯¸ì„¤ì •'}
- VITE_SUPABASE_ANON_KEY: ${import.meta.env?.VITE_SUPABASE_ANON_KEY ? 'âœ… ì„¤ì •ë¨' : 'âŒ ë¯¸ì„¤ì •'}

âš ï¸ ì£¼ì˜: ì´ í…ŒìŠ¤íŠ¸ëŠ” ë…ë¦½ HTML íŒŒì¼ì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ
Vite í™˜ê²½ ë³€ìˆ˜ì— ì§ì ‘ ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

ë©”ì¸ ì•± (localhost:5173)ì—ì„œ í™•ì¸í•˜ì„¸ìš”:
  F12 â†’ Console â†’ import.meta.env
                `;
                
                updateStatus(1, 'success', result);
            } catch (error) {
                updateStatus(1, 'error', `ì—ëŸ¬: ${error.message}`);
            }
            
            updateProgress();
        }
        
        async function test2_connectSupabase() {
            updateStatus(2, 'pending');
            
            try {
                // ì‚¬ìš©ìì—ê²Œ ì§ì ‘ ì…ë ¥ ë°›ê¸°
                const url = prompt('Supabase URLì„ ì…ë ¥í•˜ì„¸ìš”:\n(ì˜ˆ: https://xxx.supabase.co)');
                const key = prompt('Supabase ANON KEYë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
                
                if (!url || !key) {
                    throw new Error('URL ë˜ëŠ” KEYê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }
                
                window.supabase = createClient(url, key);
                
                // ê°„ë‹¨í•œ ì¿¼ë¦¬ë¡œ ì—°ê²° í…ŒìŠ¤íŠ¸
                const { data, error } = await window.supabase
                    .from('users')
                    .select('count', { count: 'exact', head: true });
                
                if (error) throw error;
                
                const result = `
âœ… Supabase ì—°ê²° ì„±ê³µ!

ì—°ê²° ì •ë³´:
- URL: ${url}
- ì¸ì¦: ANON KEY
- ìƒíƒœ: Connected

ë‹¤ìŒ í…ŒìŠ¤íŠ¸ë¥¼ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤...
                `;
                
                updateStatus(2, 'success', result);
                return true;
            } catch (error) {
                const result = `
âŒ Supabase ì—°ê²° ì‹¤íŒ¨

ì—ëŸ¬ ë©”ì‹œì§€: ${error.message}

í•´ê²° ë°©ë²•:
1. .env.local íŒŒì¼ í™•ì¸
2. Supabase Dashboardì—ì„œ API Key ì¬í™•ì¸
3. ë©”ì¸ ì•± (localhost:5173)ì—ì„œ í…ŒìŠ¤íŠ¸
                `;
                updateStatus(2, 'error', result);
                return false;
            } finally {
                updateProgress();
            }
        }
        
        async function test3_generateReferralCode() {
            updateStatus(3, 'pending');
            
            if (!window.supabase) {
                updateStatus(3, 'error', 'Supabase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                updateProgress();
                return;
            }
            
            try {
                const { data, error } = await window.supabase.rpc('generate_referral_code');
                
                if (error) throw error;
                
                const isValid = /^SHADOW[A-Z0-9]{8}$/.test(data);
                
                const result = `
âœ… ì¶”ì²œ ì½”ë“œ ìƒì„± ì„±ê³µ!

ìƒì„±ëœ ì½”ë“œ: ${data}
í˜•ì‹ ê²€ì¦: ${isValid ? 'âœ… í†µê³¼ (SHADOWXXXXXXXX)' : 'âŒ ì‹¤íŒ¨ (í˜•ì‹ ì˜¤ë¥˜)'}

í•¨ìˆ˜: generate_referral_code()
ìƒíƒœ: ì •ìƒ ì‘ë™
                `;
                
                updateStatus(3, isValid ? 'success' : 'error', result);
            } catch (error) {
                const result = `
âŒ ì¶”ì²œ ì½”ë“œ ìƒì„± ì‹¤íŒ¨

ì—ëŸ¬: ${error.message}

ì›ì¸:
- generate_referral_code() í•¨ìˆ˜ê°€ ì—†ìŒ
- ê¶Œí•œ ë¶€ì¡±

í•´ê²°:
1. Supabase SQL Editorì—ì„œ 001_initial_schema.sql ì‹¤í–‰
2. í•¨ìˆ˜ ìƒì„± í™•ì¸:
   SELECT routine_name 
   FROM information_schema.routines 
   WHERE routine_name = 'generate_referral_code';
                `;
                updateStatus(3, 'error', result);
            }
            
            updateProgress();
        }
        
        async function test4_validateReferralCode() {
            updateStatus(4, 'pending');
            
            if (!window.supabase) {
                updateStatus(4, 'error', 'Supabase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                updateProgress();
                return;
            }
            
            try {
                // ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì½”ë“œë¡œ í…ŒìŠ¤íŠ¸ (false ë°˜í™˜ ì˜ˆìƒ)
                const { data: invalid, error: error1 } = await window.supabase
                    .rpc('validate_referral_code_public', { code: 'SHADOWINVALID' });
                
                if (error1) throw error1;
                
                const result = `
âœ… ì¶”ì²œ ì½”ë“œ ê²€ì¦ í•¨ìˆ˜ ì‘ë™!

í…ŒìŠ¤íŠ¸ ê²°ê³¼:
- ë¬´íš¨í•œ ì½”ë“œ (SHADOWINVALID): ${invalid === false ? 'âœ… false ë°˜í™˜' : 'âŒ true ë°˜í™˜ (ì˜¤ë¥˜)'}

í•¨ìˆ˜: validate_referral_code_public(code TEXT)
ìƒíƒœ: ì •ìƒ ì‘ë™

ğŸ’¡ ì‹¤ì œ ìœ íš¨í•œ ì½”ë“œ í…ŒìŠ¤íŠ¸ëŠ” 
   ë©”ì¸ ì•±ì—ì„œ íšŒì›ê°€ì… í›„ ì§„í–‰í•˜ì„¸ìš”.
                `;
                
                updateStatus(4, invalid === false ? 'success' : 'error', result);
            } catch (error) {
                const result = `
âŒ ì¶”ì²œ ì½”ë“œ ê²€ì¦ ì‹¤íŒ¨

ì—ëŸ¬: ${error.message}

ì›ì¸:
- validate_referral_code_public() í•¨ìˆ˜ê°€ ì—†ìŒ

í•´ê²°:
1. SQL ìŠ¤í¬ë¦½íŠ¸ ì¬ì‹¤í–‰
2. í•¨ìˆ˜ í™•ì¸:
   SELECT routine_name 
   FROM information_schema.routines 
   WHERE routine_name = 'validate_referral_code_public';
                `;
                updateStatus(4, 'error', result);
            }
            
            updateProgress();
        }
        
        async function test5_getTotalRegistrations() {
            updateStatus(5, 'pending');
            
            if (!window.supabase) {
                updateStatus(5, 'error', 'Supabase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                updateProgress();
                return;
            }
            
            try {
                const { data, error } = await window.supabase.rpc('get_total_registrations');
                
                if (error) throw error;
                
                const result = `
âœ… ì „ì²´ ë“±ë¡ ìˆ˜ ì¡°íšŒ ì„±ê³µ!

í˜„ì¬ ì‚¬ì „ë“±ë¡ ì‚¬ìš©ì ìˆ˜: ${data}ëª…

í•¨ìˆ˜: get_total_registrations()
ìƒíƒœ: ì •ìƒ ì‘ë™

ğŸ’¡ ì‹¤ì œ ìˆ«ìëŠ” íšŒì›ê°€ì… í›„ ì¦ê°€í•©ë‹ˆë‹¤.
                `;
                
                updateStatus(5, 'success', result);
            } catch (error) {
                const result = `
âŒ ì „ì²´ ë“±ë¡ ìˆ˜ ì¡°íšŒ ì‹¤íŒ¨

ì—ëŸ¬: ${error.message}

í•´ê²°: SQL ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
                `;
                updateStatus(5, 'error', result);
            }
            
            updateProgress();
        }
        
        async function test6_checkAuthTrigger() {
            updateStatus(6, 'pending');
            
            if (!window.supabase) {
                updateStatus(6, 'error', 'Supabase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                updateProgress();
                return;
            }
            
            try {
                // íŠ¸ë¦¬ê±° ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (RPCë¡œëŠ” ë¶ˆê°€ëŠ¥, ì•ˆë‚´ ë©”ì‹œì§€ë§Œ í‘œì‹œ)
                const result = `
âš ï¸ Auth íŠ¸ë¦¬ê±° í™•ì¸

ì´ í…ŒìŠ¤íŠ¸ëŠ” Supabase SQL Editorì—ì„œ ì§ì ‘ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤:

1. Supabase Dashboard â†’ SQL Editor
2. ë‹¤ìŒ ì¿¼ë¦¬ ì‹¤í–‰:

   SELECT * 
   FROM information_schema.triggers 
   WHERE trigger_schema = 'auth' 
   AND trigger_name = 'on_auth_user_created';

ì˜ˆìƒ ê²°ê³¼:
- trigger_name: on_auth_user_created
- event_object_table: users
- action_statement: EXECUTE FUNCTION public.handle_new_auth_user()

ğŸ’¡ ì‹¤ì œ ì‘ë™ í…ŒìŠ¤íŠ¸ëŠ” ë©”ì¸ ì•±ì—ì„œ íšŒì›ê°€ì…ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”:
   1. http://localhost:5173 ì ‘ì†
   2. íšŒì›ê°€ì… ì§„í–‰
   3. Supabase Logs í™•ì¸ (Dashboard â†’ Database â†’ Logs)
   4. [TRIGGER] ë©”ì‹œì§€ ê²€ìƒ‰
                `;
                
                updateStatus(6, 'success', result);
            } catch (error) {
                updateStatus(6, 'error', `ì—ëŸ¬: ${error.message}`);
            }
            
            updateProgress();
        }
        
        window.runAllTests = async function() {
            window.testResults = { total: 6, passed: 0, failed: 0 };
            
            await test1_checkEnvVars();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const connected = await test2_connectSupabase();
            if (!connected) {
                // ì—°ê²° ì‹¤íŒ¨ ì‹œ ë‚˜ë¨¸ì§€ í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸°
                for (let i = 3; i <= 6; i++) {
                    updateStatus(i, 'error', 'Supabase ì—°ê²° ì‹¤íŒ¨ë¡œ ê±´ë„ˆëœ€');
                }
                updateProgress();
                return;
            }
            
            await new Promise(resolve => setTimeout(resolve, 500));
            await test3_generateReferralCode();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            await test4_validateReferralCode();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            await test5_getTotalRegistrations();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            await test6_checkAuthTrigger();
        };
    </script>
</body>
</html>

